# VM Tests Migration Status

This document tracks the migration status of VM tests from s-expression syntax to FLC syntax.

## Tests Using S-Expression Syntax (Need Migration)

Based on grep searches for `(lambda`, `(define`, and other s-expression patterns:

### High Priority (Core functionality)
- [~] `async_await_test.rs` - Partially migrated, still has compiler errors
- [ ] `spawn_integration_test.rs` - Uses `(lambda` syntax
- [ ] `define_tests.rs` - Uses `(define` syntax
- [ ] `module_tests.rs` - Uses `(define` for modules
- [ ] `module_loading_test.rs` - Uses `(define` syntax

### Medium Priority (Feature tests)
- [ ] `catch_parameter_scoping_test.rs` - Uses `(lambda` syntax
- [ ] `async_comprehensive_test.rs` - Uses both `(lambda` and `(define`
- [ ] `select_test.rs` - Uses `(lambda` syntax
- [ ] `actor_test.rs` - Uses `(lambda` syntax
- [ ] `begin_tests.rs` - Uses `(lambda` and `(define`
- [ ] `compiler_begin_tests.rs` - Uses `(define` syntax

### Low Priority (Extended tests)
- [ ] `compiler_async_tests.rs` - Uses `(lambda` syntax
- [ ] `compiler_tests_extended.rs` - Uses `(lambda` syntax
- [ ] `compiler_coverage_tests.rs` - Uses `(lambda` syntax
- [ ] `compiler_uncovered_tests.rs` - Uses `(define` syntax
- [ ] `compiler_module_tests.rs` - Uses `(define` syntax
- [ ] `error_handler_limits_test.rs` - Uses `(define` syntax
- [ ] `iot_demo_test.rs` - Uses `(define` syntax

## Tests Using Direct AST Construction (No Migration Needed)
- `stdlib_integration_test.rs` - Builds AST directly
- Various other tests that construct AST nodes directly

## Migration Status

### Completed âœ…
- `define_tests.rs` - All 7 tests migrated and passing
- `begin_tests.rs` - 14/21 tests migrated and passing
  - 7 tests fail due to missing FLC features (see limitations below)
- `safety_test.rs` - Migrated test_stack_trace_generation
- `test_simple_pattern.rs` - Migrated and passing (or patterns work!)
- `compiler_begin_tests.rs` - 7/10 tests migrated and passing
  - 3 tests ignored due to FLC limitations (effects, print, different compilation)
- Fixed compiler bugs found during migration:
  - LoadLocal0-3 opcodes not incrementing stack_depth
  - PopN stack depth calculation
  - Lambda parameter stack initialization

### In Progress ðŸ”„
None currently

### Blocked â›”
- `async_await_test.rs` - Runtime limitation: Cannot use block_on within tokio runtime
  - Tests require running in tokio::test context
  - VM.run() uses block_on internally which conflicts
  - Needs architectural change to support async tests

- `module_tests.rs` - FLC parser lacks module system support
  - No export declarations in module syntax
  - Import/use statements generate different AST nodes
  - Tests verify specific opcodes not generated by FLC
  - Requires implementing full module system in FLC parser

- `handler_let_test.rs` & `test_simple_handler.rs` - FLC lacks handler expressions
  - Only handler method definitions in actors are supported
  - No syntax for handler expressions like `(handler ((error ...)) body)`
  - Tests marked with #[ignore]

### Not Started ðŸ“‹
All other tests listed above need migration

## Migration Blockers

1. **S-expression parser removed**
   - Parser no longer supports s-expression syntax
   - All tests MUST be migrated to FLC or use direct AST construction
   - No fallback available

2. **FLC module system incomplete**
   - Module syntax doesn't support exports
   - Import/use syntax generates different AST than expected
   - Blocks migration of module-related tests

3. **FLC missing features discovered during migration**
   - No support for `set!` or variable mutation
   - `effect` syntax doesn't parse as statement
   - No `quote` function for creating symbols
   - String concatenation with `+` is not supported (type error)
   - `print` function is not defined in stdlib
   - Cannot reference undefined variables (even for assignment)

4. **Async runtime limitations**
   - Cannot use block_on within existing tokio runtime
   - Blocks proper testing of async/await features

## Recommendations

1. Start by implementing spawn syntax in FLC parser
2. Create a test utility that can parse both syntaxes during migration
3. Migrate tests incrementally, starting with high priority ones
4. Consider creating AST builder utilities to simplify test writing